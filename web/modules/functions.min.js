function isKeyPressed(e){e.ctrlKey?cntrlIsPressed=!0:cntrlIsPressed=!1}function apply_theme(e){color_apply="",color_grid_apply="",color_dark="#adafae",color_not_dark=Chart.defaults.color,color_grid=Chart.defaults.borderColor,bootstrap_theme.setAttribute("href",bootstrap_theme_path),tabulator_theme.setAttribute("href",tabulator_theme_path),0==e?(color_apply=color_not_dark,color_grid_apply=color_grid):1==e||2==e||5==e?(color_apply=color_dark,color_grid_apply=color_dark):(color_apply=color_not_dark,color_grid_apply=color_grid),config_strain.options.scales.y.ticks.color=color_apply,config_strain.options.scales.x.ticks.color=color_apply,config_strain.options.scales.x.title.color=color_apply,config_strain.options.scales.y.title.color=color_apply,config_strain.options.scales.y.grid.color=color_grid_apply,config_strain.options.scales.x.grid.color=color_grid_apply,strain_chart.update(),config_dw.options.scales.y.ticks.color=color_apply,config_dw.options.scales.x.ticks.color=color_apply,config_dw.options.scales.x.title.color=color_apply,config_dw.options.scales.y.title.color=color_apply,config_dw.options.scales.y.grid.color=color_grid_apply,config_dw.options.scales.x.grid.color=color_grid_apply,dw_chart.update(),config_xrd_gaph.options.scales.y.ticks.color=color_apply,config_xrd_gaph.options.scales.x.ticks.color=color_apply,config_xrd_gaph.options.scales.x.title.color=color_apply,config_xrd_gaph.options.scales.y.title.color=color_apply,config_xrd_gaph.options.scales.y.grid.color=color_grid_apply,config_xrd_gaph.options.scales.x.grid.color=color_grid_apply,xrd_gaph.update()}function test_checked_all(e,t){var a=[],o=0,l=table_strain_dw_values.getData();Object.entries(l).forEach(([t,l])=>{var _=l.dw_choice;1==e&&(_=l.strain_choice),_&&a.push(1),o+=1}),Array.isArray(a)&&a.length&&a.length==o?document.getElementById(t).checked=!0:document.getElementById(t).checked=!1}function delete_region(){table_exclude_region.deleteRow(rowSelect),modal_delete_region.classList.add("disabled"),draw_region_graph()}function validate(e){var t=e||window.event;if("paste"===t.type)a=event.clipboardData.getData("text/plain");else{var a=t.keyCode||t.which;a=String.fromCharCode(a)}var o=/[0-9]|\./;o.test(a)||(t.returnValue=!1,t.preventDefault&&t.preventDefault())}var store_row=null,store_row_data=null,res_data="",res_db="",graph_data="",init_data="",data_interface="",browser_choice=1,tools=null;init_graph_strain=0,init_graph_dw=0,model_strain_dw=null,change_model=0,splash_time=5e3,radioValue=0,after_one_fit=0,save_bounds_values_4_restore="",nb_cycle_max_save=0,val2save="",fitting2save="",crystal_choice_select=0,crystal_choice_select_sub=0,dragPointsX=!1,dragPointsY=!1,scale_min_strain=0,scale_max_strain=1,scale_min_dw=0,scale_max_dw=1,dw_chart_zoomed=0,strain_chart_zoomed=0,startingValueDrag=0,value2add=0,previous_value=0,isROI=!1,rectROI={},dragROI=!1,dragExclude=!1,cntrlIsPressed=!1,isSelectedPoints=!1,SelectedPoints=[],rowSelect=0,exclude_region_data=[],DateTime=luxon.DateTime;let table_strain_dw_values=null,table_database=null,table_exclude_region=null,table=null,chart_x_start=0,chart_y_start=0,chart_x_end=0,chart_y_end=0,x_start=0,y_start=0,x_end=0,y_end=0;var roi_coord={chart_x_start:0,chart_x_end:0,chart_y_start:0,chart_y_end:0},xrd_bounds={xmin_xrd:0,xmax_xrd:0},selectRectExclude={w:0,startX:0,startY:0},graph_colors_equivalents={color_strain_modal:"c_strain",color_dw_modal:"c_dw",color_xrd_data_modal:"c_data",color_xrd_fit_modal:"c_fit",color_xrd_live_modal:"c_fit_live"};let img_schem_list={0:"Scheme_SingleCrystal.png",1:"Scheme_ThinFilm.png",2:"Scheme_ThickFilm.png",3:"Scheme_ThickFilmAndSubstrate.png"},par_lattice=["a","b","c","alpha","beta","gamma"],param_lattice=["a_lattice","b_lattice","c_lattice","alpha_lattice","beta_lattice","gamma_lattice"];const container=document.querySelector("#parameters_pane"),click_update_1=document.getElementById("click_update_1"),click_update_2=document.getElementById("click_update_2"),new_project=document.getElementById("new_project"),load_project=document.getElementById("load_project"),loads_xrd=document.getElementById("loads_xrd"),loads_strain=document.getElementById("loads_strain"),loads_dw=document.getElementById("loads_dw"),save_file=document.getElementById("save_file"),save_as_file=document.getElementById("save_as_file"),export_fits=document.getElementById("export_fits"),menu_file_hide=document.getElementById("menu_file_hide"),menu_about_hide=document.getElementById("menu_about_hide"),menu_options_hide=document.getElementById("menu_options_hide"),path_name=document.getElementById("path_name"),current_name=document.getElementById("current_name"),radmax_tab=document.getElementById("radmax-tab"),about_modal=document.getElementById("about_modal"),general_options_modal=document.getElementById("general_options_modal"),graph_colors_modal=document.getElementById("graph_colors_modal"),sounds_open=document.getElementById("sounds_open"),sounds_play=document.getElementById("sounds_play"),radmax_use_database=document.getElementById("radmax_use_database"),database_panel=document.getElementById("database_pane-tab"),radmax_version=document.getElementById("radmax_version"),labelImage=document.getElementById("sheme_img"),crystal_choice=document.getElementById("crystal_choice_m"),crystal_choice_s=document.getElementById("crystal_choice_s"),dw_function=document.getElementById("dw_basis_func"),modal_wait=document.getElementById("myModal"),img=document.getElementById("myImg"),modalImg=document.getElementById("img01"),captionText=document.getElementById("caption"),captionTextWait=document.getElementById("caption_wait"),hide_film_thickness=document.getElementById("hide_film_thickness"),hide_film_thickness_substrate=document.getElementById("hide_film_thickness_substrate"),delete_switch=document.getElementById("DeleteDataSwitch"),DragXPoints=document.getElementById("DragXPoints"),fitting_options=document.getElementById("fitting_options"),width_left_hide=document.getElementById("width_left_hide"),width_right_hide=document.getElementById("width_right_hide"),shape_left_hide=document.getElementById("shape_left_hide"),shape_right_hide=document.getElementById("shape_right_hide"),b_bell_hide=document.getElementById("b_bell_hide"),width_left_label=document.getElementById("width_left_label"),shape_left_label=document.getElementById("shape_left_label"),shape_right_label=document.getElementById("shape_right_label"),width_right_label=document.getElementById("width_right_label"),spinner_fit_hide=document.getElementById("spinner_fit_hide"),parameters_pane_tab=document.getElementById("parameters_pane-tab"),fitting_pane_tab=document.getElementById("fitting_pane-tab"),geometry_pane_tab=document.getElementById("geometry_pane-tab"),database_pane_tab=document.getElementById("database_pane-tab"),start_fit_button=document.getElementById("start_fit_button"),stop_fit_button=document.getElementById("stop_fit_button"),strain_button_restore=document.getElementById("strain_button_restore"),dw_button_restore=document.getElementById("dw_button_restore"),boh_button_restore=document.getElementById("boh_button_restore"),fit_state_hide=document.getElementById("fit_state_hide"),fit_residual_hide=document.getElementById("fit_residual_hide"),fit_state_error_hide=document.getElementById("fit_state_error_hide"),fit_state_success_hide=document.getElementById("fit_state_success_hide"),fit_error=document.getElementById("fit_error"),gsa_current_cycle=document.getElementById("gsa_current_cycle"),nb_cycle_max=document.getElementById("nb_cycle_max"),strain_scale=document.getElementById("strain_scale"),dw_scale=document.getElementById("dw_scale"),fitting_choice=document.getElementById("fitting_choice"),resolution_func=document.getElementById("resolution_func"),model_strain=document.getElementById("model_strain"),modal_fitting_options=document.getElementById("modal_fitting_options"),modal_strain_dw_values=document.getElementById("modal_strain_dw_values"),color_strain_modal=document.getElementById("color_strain_modal"),color_dw_modal=document.getElementById("color_dw_modal"),color_xrd_data_modal=document.getElementById("color_xrd_data_modal"),color_xrd_fit_modal=document.getElementById("color_xrd_fit_modal"),color_xrd_live_modal=document.getElementById("color_xrd_live_modal"),modal_change_limits=new bootstrap.Modal(document.getElementById("modal_change_limits")),modal_change_basis_function=new bootstrap.Modal(document.getElementById("modal_change_basis_function")),modal_about=new bootstrap.Modal(document.getElementById("modal_about")),modal_options=new bootstrap.Modal(document.getElementById("modal_options")),modal_colors=new bootstrap.Modal(document.getElementById("modal_colors")),modal_check_input_file=new bootstrap.Modal(document.getElementById("modal_check_input_file")),modal_open_exclude_region=new bootstrap.Modal(document.getElementById("modal_open_exclude_region")),start_exclude_region=document.getElementById("start_exclude_region"),end_exclude_region=document.getElementById("end_exclude_region"),modal_delete_region=document.getElementById("modal_delete_region"),checkboxAllDW=document.getElementsByClassName("checkbox_check_all_dw")[0],checkboxAllStrain=document.getElementsByClassName("checkbox_check_all_strain")[0],canvas_strain=document.getElementById("strain_canvas"),ctx_strain=canvas_strain.getContext("2d"),canvas_dw=document.getElementById("dw_canvas"),ctx_dw=canvas_dw.getContext("2d"),overlay_strain=document.getElementById("overlay_strain"),overlay_dw=document.getElementById("overlay_dw"),selectionContextStrain=overlay_strain.getContext("2d"),selectionContextDw=overlay_dw.getContext("2d"),canvas_xrd=document.getElementById("xrd_graph"),overlay_xrd=document.getElementById("overlay_xrd"),selectionContextXRD=overlay_xrd.getContext("2d"),ctx_xrd=canvas_xrd.getContext("2d"),strain_chart=new Chart(canvas_strain,config_strain),dw_chart=new Chart(canvas_dw,config_dw),xrd_gaph=new Chart(ctx_xrd,config_xrd_gaph),graph_coords=document.getElementById("graph_coords_strain_dw"),graph_coords_xrd=document.getElementById("graph_coords_xrd");overlay_strain.width=canvas_strain.width,overlay_strain.height=canvas_strain.height,overlay_dw.width=canvas_dw.width,overlay_dw.height=canvas_dw.height,overlay_xrd.width=canvas_xrd.width,overlay_xrd.height=canvas_xrd.height,stop_fit_button.classList.add("disabled"),modal_delete_region.classList.add("disabled");const bootstrap_theme_path="/css/boostrap.min.css",tabulator_theme_path="/modules/tabulator/5.0.7/css/tabulator_read.min.css",bootstrap_theme=document.getElementById("theme_for_bootstrap"),theme_bootstrap_choice=document.getElementById("theme_bootstrap_choice"),tabulator_theme=document.getElementById("theme_for_tabulator");theme_bootstrap_choice.addEventListener("change",function(e){change_theme(this.value,1),apply_theme(this.value)}),table_strain_dw_values=new Tabulator("#table_strain_dw_values",{layout:"fitColumns",data:[],movableColumns:!1,resizableRows:!1,columns:[{title:"Index",field:"name",frozen:!0,headerSort:!1},{title:"Depth",field:"x_value",frozen:!0,headerSort:!1},{title:"Strain",field:"strain",frozen:!0,headerSort:!1,editor:!0},{title:"<input id='checkbox_check_all_strain' class='checkbox_check_all_strain' type='checkbox'/>",field:"strain_choice",width:"5%",headerSort:!1,formatter:function(e,t){return 1==e.getValue()?'<input type="checkbox" checked class="checkbox_check_strain">':'<input type="checkbox" class="checkbox_check_strain">'}},{title:"DW",field:"dw",frozen:!0,headerSort:!1,editor:!0},{title:"<input id='checkbox_check_all_dw' class='checkbox_check_all_dw' type='checkbox'/>",field:"dw_choice",width:"5%",headerSort:!1,frozen:!0,formatter:function(e,t){return 1==e.getValue()?'<input type="checkbox" checked class="checkbox_check_dw">':'<input type="checkbox" class="checkbox_check_dw">'}}]}),table_strain_dw_values.on("headerClick",function(e,t){var a=table_strain_dw_values.getData();if("checkbox_check_all_strain"==e.path[0].className){var o=!1;e.path[0].checked&&(o=!0),Object.entries(a).forEach(([e,t])=>{t.strain_choice=o})}if("checkbox_check_all_dw"==e.path[0].className){o=!1;e.path[0].checked&&(o=!0),Object.entries(a).forEach(([e,t])=>{t.dw_choice=o})}table_strain_dw_values.clearData(),table_strain_dw_values.updateOrAddData([a])}),table_strain_dw_values.on("rowClick",function(e,t){var a=t.getData(),o=0;"checkbox_check_strain"==e.path[0].className?(e.path[0].checked?a.strain_choice=!0:a.strain_choice=!1,which_check=1,which_check_class="checkbox_check_all_strain",o=1):"checkbox_check_dw"==e.path[0].className&&(e.path[0].checked?a.dw_choice=!0:a.dw_choice=!1,which_check=0,which_check_class="checkbox_check_all_dw",o=1),1==o&&(table_strain_dw_values.updateData([a]),test_checked_all(which_check,which_check_class))});var dateFormatter=function(e,t){var a=e.getValue();return a&&(a=DateTime.fromSQL(a).toFormat("yyyy-LL-dd HH:mm:ss")),a};table_database=new Tabulator("#table_database",{layout:"fitColumns",data:[],selectable:1,pagination:"local",paginationSize:15,movableColumns:!1,resizableRows:!1,initialSort:[{column:"date",dir:"desc"}],columns:[{title:"id",field:"id",visible:!1},{title:"Date",field:"date",formatter:dateFormatter,sorter:"datetime",sorterParams:{format:"yyyy-LL-dd HH:mm:ss",alignEmptyValues:"top"}},{title:"Exp. name",field:"exp_name"},{title:"Crystal name",field:"crys_name"},{title:"Fit algo.",field:"fit_algo"},{title:"Fit success",field:"fit_success"},{title:"Residual",field:"residual"},{title:"Geometry",field:"geometry"},{title:"Model",field:"model"}]}),table_database.on("rowClick",function(e,t){store_row_data=t.getData(),read_db_data(store_row_data.id)}),document.getElementById("select-all").addEventListener("click",function(){table_database.selectRow()}),document.getElementById("deselect-all").addEventListener("click",function(){table_database.deselectRow()}),table_exclude_region=new Tabulator("#table_exclude_region",{height:"311px",layout:"fitColumns",data:[],selectable:1,paginationSize:15,movableColumns:!1,resizableRows:!0,initialSort:[{column:"exclude_start_region",dir:"asc"}],columns:[{title:"Start region",field:"exclude_start_region",width:200,hozAlign:"left",headerHozAlign:"left",sorter:"number",headerSort:!1},{title:"End region",field:"exclude_end_region",width:200,hozAlign:"left",headerHozAlign:"left",sorter:"number",headerSort:!1}]}),table_exclude_region.on("rowSelected",function(e){rowSelect=e,modal_delete_region.classList.remove("disabled")}),table_exclude_region.on("rowDeselected",function(e){rowSelect=0,modal_delete_region.classList.add("disabled")});